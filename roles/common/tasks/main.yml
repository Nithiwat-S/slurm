# roles/common/tasks

# common tasks for all linodes
- name: force ipv4 with apt
  copy:
    content: 'Acquire::ForceIPv4 "true";'
    dest: /etc/apt/apt.conf.d/99force-ipv4

- name: apt update
  apt:
    update_cache: yes

- name: apt upgrade
  apt:
    upgrade: full

- name: install basic packages
  apt:
    pkg:
    - ntp
    - wget
    - curl
    - htop
    - rsync
    - software-properties-common  
#    - gnupg2
#    - ssl-cert
    - python3
    - python3-passlib
    #- firewalld
    state: present

#- name: configure firewalld
#  import_tasks: firewall.yml

- name: secure ssh configs
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.search }}"
    line: "{{ item.replace }}"
  loop:
    - { search: '^\#?PermitRootLogin (yes|no)', replace: 'PermitRootLogin without-password' }
    - { search: '^\#?PasswordAuthentication (yes|no)', replace: 'PasswordAuthentication no' }
    - { search: '^\#?PubkeyAuthentication (yes|no)', replace: 'PubkeyAuthentication yes' }
  notify: restart ssh